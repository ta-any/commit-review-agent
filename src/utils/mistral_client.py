# mistral_client.py
import os
from mistralai import Mistral
from loguru import logger

API_KEY = os.getenv("MISTRAL_API_KEY")
if not API_KEY:
    raise EnvironmentError("Необходимо установить переменную окружения MISTRAL_API_KEY")

# Используем асинхронный клиент
async def get_long_completion(user_prompt: str) -> str:
    """
    Асинхронно генерирует максимально длинный ответ от Mistral AI с учётом системного промта.

    :param user_prompt: Запрос от пользователя (обычно содержимое кода для ревью).
    :return: Текст технического ревью от модели.
    """
    system_prompt = """Ты — опытный, профессиональный программист, проводишь код-ревью. Ты придерживаешься правил структурного программирования. У тебя есть вот правила написания кода: 
            # Принципы структурного программирования
            Становление и развитие структурного программирования связано с именем Эдсгера Дейкстры.
            * Принцип 1. Следует отказаться от использования оператора безусловного перехода goto.
            * Принцип 2. Любая программа строится из трёх базовых управляющих конструкций: последовательность, ветвление, цикл.
            * Принцип 3. В программе базовые управляющие конструкции могут быть вложены друг в друга произвольным образом. Никаких других средств управления последовательностью выполнения операций не предусматривается.
            * Принцип 4. Повторяющиеся фрагменты программы можно оформить в виде подпрограмм (процедур и функций). Таким же образом (в виде подпрограмм) можно оформить логически целостные фрагменты программы, даже если они не повторяются.
            * Принцип 5. Каждую логически законченную группу инструкций следует оформить как блок. Блоки являются основой структурного программирования.
            * Принцип 6. Все перечисленные конструкции должны иметь один вход и один выход.
            * Принцип 7. Разработка программы ведётся пошагово, методом «сверху вниз» (top-down method).

            Следствия и дополнения вышеизложенных принципов:

            1. Запрет на использование глобальных переменных
            2. Не более одного выхода из функции. Исключение составляет предварительная проверка аргументов функции.
            3. Не более одного выхода из цикла - это может быть как условие, так и ключевое слово break
            4. Вложенность любых блоков не должна превышать 4
            5. Размер функций ограничен по строкам и составляет 40-50 строк. Тебе нужно сделать ревью кода используя эти принципы.
            Результатом проверки напиши короткий технический обзор для программиста."""

    max_response_tokens = 32768
    temperature: float = 0.7

    messages = [
        {"role": "system", "content": system_prompt},
        {"role": "user", "content": user_prompt}
    ]

    logger.info(
            f"✅ Отправлен запрос в ИИ. "
    )
    try:
        async with Mistral(api_key=API_KEY) as mistral:
            response = await mistral.chat.complete_async(
                model="mistral-large-latest",
                messages=messages,
                max_tokens=max_response_tokens,
                stream=False,
                temperature=temperature,
            )
            
            assistant_response = response.choices[0].message.content

            logger.info(
                f"✅ Получен ответ ИИ (длина: {len(assistant_response)}). "
                f"Превью: {assistant_response[:150]}..."
            )
  
            return assistant_response
        
    except Exception as e:
        logger.error(f"Ошибка при вызове Mistral API: {e}")
        raise